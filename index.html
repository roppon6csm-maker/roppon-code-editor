<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Roppon Code Editor Ver.2.4</title>
<style>
/* --- 1. 基本設定 --- */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", sans-serif; }
body { margin: 0; padding: 0; background-color: #000; color: #fff; overflow: hidden; width: 100vw; height: 100vh; }
input, select, button { outline: none; border: none; background: none; color: inherit; }

#app { display: flex; flex-direction: column; width: 100%; height: 100%; }

/* --- 2. グローバル設定エリア --- */
header { flex: 0 0 auto; width: 100%; padding: env(safe-area-inset-top) 0 10px 0; background: #000; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #333; z-index: 100; }
.app-title { font-size: 5vw; font-weight: 800; color: #666; margin: 10px 0; letter-spacing: 1px; }
.header-settings { width: 96%; display: flex; justify-content: space-between; gap: 2vw; }

.setting-group { flex: 1; display: flex; flex-direction: column; align-items: center; background: #111; border-radius: 8px; padding: 5px 0; border: 1px solid #333; }
.setting-label { font-size: 2.5vw; color: #888; margin-bottom: 2px; font-weight: bold; text-transform: uppercase; }
.global-select { width: 100%; text-align: center; font-size: 4vw; font-weight: bold; appearance: none; text-align-last: center; padding: 2px 0; }

#bpm-select { color: #00E5FF; }
#key-select { color: #FFD60A; }
#beat-select { color: #FF9F0A; }
#drum-select { color: #32D74B; }

/* --- 3. コード行リストエリア --- */
#list-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.col-headers { display: flex; width: 100%; padding: 5px 2vw; background: #050505; color: #555; font-size: 2.2vw; font-weight: bold; text-transform: uppercase; border-bottom: 1px solid #222; }
.col-h-loop { width: 10%; text-align: center; } 
.col-h-part { width: 18%; text-align: center; } 
.col-h-chord { width: 32%; text-align: center; } 
.col-h-tmpl { width: 30%; text-align: center; } 
.col-h-del { width: 10%; }

main { flex: 1; overflow-y: auto; padding: 10px 2vw 220px 2vw; -webkit-overflow-scrolling: touch; }
main::-webkit-scrollbar { display: none; }

.line-row { height: 85px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #161616; border-radius: 10px; border: 1px solid #222; padding: 0 1vw; position: relative; }
.line-row.playing { border: 2px solid #00E5FF; box-shadow: 0 0 15px rgba(0, 229, 255, 0.3); background: #222; }

.loop-btn { width: 28px; height: 28px; border-radius: 50%; border: 2px solid #444; background: #000; margin: 0 auto; transition: 0.2s; }
.loop-btn.active { background-color: #00E5FF; border-color: #00E5FF; box-shadow: 0 0 8px #00E5FF; }

.part-wrapper { width: 18%; }
.part-select { width: 100%; font-size: 3.2vw; color: #fff; background: #222; border-radius: 4px; padding: 6px 0; text-align: center; border: 1px solid #333; }

.chord-wrapper { width: 32%; padding: 0 1vw; }
.chords-input { width: 100%; height: 45px; background: #000; border: 1px solid #333; border-radius: 4px; color: #00E5FF; font-size: 4vw; text-align: center; font-weight: bold; }

/* テンプレート表示エリア（文字サイズを最大化） */
.template-display { width: 30%; height: 80%; background: #222; border-radius: 6px; display: flex; flex-direction: column; justify-content: space-evenly; align-items: flex-start; padding: 4px 8px; border: 1px solid #444; overflow: hidden; }
.td-name { font-size: 3.2vw; font-weight: bold; color: #fff; white-space: nowrap; line-height: 1.1; }
.td-deg { font-size: 2.8vw; color: #00E5FF; white-space: nowrap; line-height: 1.1; }
.td-usage { font-size: 2.4vw; color: #aaa; white-space: nowrap; line-height: 1.1; }

.del-btn { width: 10%; text-align: center; color: #444; font-size: 6vw; }

.add-btn { margin-top: 10px; width: 100%; height: 60px; border: 2px dashed #333; border-radius: 10px; color: #555; font-size: 30px; display: flex; align-items: center; justify-content: center; }

/* --- 4. 再生コントロールエリア（表示切れ修正） --- */
.controls-overlay { position: fixed; bottom: 0; left: 0; width: 100%; height: 180px; pointer-events: none; background: linear-gradient(to top, #000 75%, transparent); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 200; padding-bottom: env(safe-area-inset-bottom); }
.play-btn { width: 90px; height: 90px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 900; letter-spacing: 1px; pointer-events: auto; transition: 0.1s; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
.play-btn.play { background: #fff; color: #000; border: 5px solid #333; }
.play-btn.stop { background: #FF3B30; color: #fff; border: 5px solid #800; box-shadow: 0 0 25px rgba(255, 59, 48, 0.5); }
.play-btn:active { transform: scale(0.95); }

/* --- 5. モーダル --- */
#modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
#modal-content { width: 92%; max-height: 85%; background: #1a1a1a; border-radius: 15px; overflow-y: auto; padding: 20px; border: 1px solid #333; }
.modal-title { text-align: center; font-size: 5vw; color: #fff; margin-bottom: 20px; font-weight: bold; }
.modal-section { color: #888; font-size: 3.5vw; margin: 15px 0 8px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
.modal-item { background: #252525; margin-bottom: 10px; padding: 12px; border-radius: 10px; border: 1px solid #333; }
.m-name { font-size: 4vw; font-weight: bold; color: #fff; }
.m-deg { font-size: 3.5vw; color: #00E5FF; margin: 4px 0; }
.m-usage { font-size: 3vw; color: #aaa; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="app-title">Roppon Code Editor</div>
    <div class="header-settings">
      <div class="setting-group"><div class="setting-label">BPM</div><select id="bpm-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">KEY</div><select id="key-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">BEAT</div><select id="beat-select" class="global-select"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option></select></div>
      <div class="setting-group"><div class="setting-label">DRUM</div><select id="drum-select" class="global-select"><option value="Straight">Straight</option><option value="Shuffle" selected>Shuffle</option><option value="Open">Open</option><option value="Trap">Trap</option></select></div>
    </div>
  </header>

  <div id="list-wrapper">
    <div class="col-headers">
      <div class="col-h-loop">Loop</div><div class="col-h-part">Part</div><div class="col-h-chord">Chords</div><div class="col-h-tmpl">Template</div><div class="col-h-del"></div>
    </div>
    <main id="line-container"><div class="add-btn" id="add-btn">+</div></main>
    <div class="controls-overlay"><div class="play-btn play" id="play-btn">PLAY</div></div>
  </div>
</div>
<div id="modal-overlay"><div id="modal-content"></div></div>

<script>
/**
 * Roppon Code Editor Ver.2.4
 */

const KEYS = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const PARTS = ["イントロ", "Aメロ", "Bメロ", "プレコーラス", "サビ", "間奏", "Cメロ", "アウトロ"];
const TEMPLATE_CATEGORIES = [
  { cat: "王道・定番系", list: [
    { name: "王道進行", deg: "I-V-vi-IV", usage: "サビ最頻出" },
    { name: "マイナー王道", deg: "vi-IV-I-V", usage: "切な系サビ" },
    { name: "逆王道", deg: "IV-V-iii-vi", usage: "Aメロ／Bメロ" }
  ]},
  { cat: "J-POP特化進行", list: [
    { name: "小室進行", deg: "vi-IV-V-I", usage: "90s感・疾走" },
    { name: "丸サ進行", deg: "IV-V-iii-vi", usage: "歌い出し安定" },
    { name: "カノン進行", deg: "I-V-vi-iii-IV-I-IV-V", usage: "長尺サビ" }
  ]},
  { cat: "アイドル・アニソン頻出", list: [
    { name: "4度進行", deg: "I-IV-vii°-iii-vi-ii-V-I", usage: "元気・明るい" },
    { name: "泣き進行", deg: "I-iii-vi-V", usage: "感情表現" },
    { name: "青春進行", deg: "I-V-IV-V", usage: "若さ・疾走" }
  ]},
  { cat: "メロ用・ブリッジ用", list: [
    { name: "Bメロ定番", deg: "ii-V-I", usage: "溜め" },
    { name: "ブリッジ上昇", deg: "IV-V-V/vi-vi", usage: "サビ前" },
    { name: "転調前進行", deg: "I-V-V/II", usage: "キーアップ直前" }
  ]},
  { cat: "エモ・ロック寄り", list: [
    { name: "エモ進行", deg: "vi-I-V-IV", usage: "エモい" },
    { name: "ロック定番", deg: "I-bVII-IV", usage: "ロック定番展開" }
  ]}
];

let ALL_TEMPLATES = [];
TEMPLATE_CATEGORIES.forEach(c => ALL_TEMPLATES = ALL_TEMPLATES.concat(c.list));

const DEG_TO_SEMITONE = { "I":0, "II":2, "ii":2, "iii":4, "III":4, "IV":5, "iv":5, "V":7, "v":7, "vi":9, "VI":9, "vii°":11, "bVII":10, "V/vi": 11, "V/II": 9 };

let state = {
  bpm: 164, keyIndex: 0, beat: 16, drum: "Straight", isPlaying: false,
  lines: [
    { loop: true, part: "イントロ", chords: "F-G-Am-Am", templateName: "王道進行", templateDeg: "I-V-vi-IV", templateUsage: "サビ最頻出" },
    { loop: true, part: "Aメロ", chords: "Am-F-C-G", templateName: "マイナー王道", templateDeg: "vi-IV-I-V", templateUsage: "切な系サビ" }
  ],
  currentLineIndex: -1, currentBeatGlobal: 0, nextNoteTime: 0
};

let audioCtx = null;
let schedulerInterval = null;

function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

function playKick(time, style) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.frequency.setValueAtTime(style === "Trap" ? 150 : 120, time);
  osc.frequency.exponentialRampToValueAtTime(style === "Trap" ? 30 : 50, time + 0.1);
  gain.gain.setValueAtTime(0.8, time);
  gain.gain.exponentialRampToValueAtTime(0.01, time + 0.2);
  osc.start(time); osc.stop(time + 0.2);
}

function playPiano(freq, time, duration, style) {
  if (freq <= 0) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = (style === "Trap") ? 'sawtooth' : 'triangle';
  osc.frequency.setValueAtTime(freq, time);
  gain.gain.setValueAtTime(0, time);
  gain.gain.linearRampToValueAtTime(0.2, time + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.01, time + duration);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(time); osc.stop(time + duration);
}

function getFreq(noteName) {
  const noteMap = { "C":0, "C#":1, "D":2, "D#":3, "E":4, "F":5, "F#":6, "G":7, "G#":8, "A":9, "A#":10, "B":11 };
  let base = noteName.replace(/m|dim|7|M7|sus4|aug/g, "").split("/")[0];
  let index = noteMap[base];
  if (index === undefined) return 0;
  return 440 * Math.pow(2, (index - 9 - 12) / 12);
}

// 修正されたスケジューラ：16分音符単位で確実に呼び出し
function scheduler() {
  while (state.nextNoteTime < audioCtx.currentTime + 0.1) {
    scheduleNote(state.currentBeatGlobal, state.nextNoteTime);
    const secondsPer16th = (60.0 / state.bpm) / 4;
    state.nextNoteTime += secondsPer16th;
    state.currentBeatGlobal++;
  }
}

function scheduleNote(beatNumber, time) {
  if (state.currentLineIndex === -1) return;
  const line = state.lines[state.currentLineIndex];
  const chords = line.chords.split("-").map(c => c.trim()).filter(c => c);
  if (chords.length === 0) return;

  const total16ths = 16; 
  const cycleBeat = beatNumber % total16ths;
  const chordIdx = Math.floor((cycleBeat / total16ths) * chords.length);
  const currentChord = chords[chordIdx];

  // ドラム：BEAT設定に応じた間隔でキック
  const kickInterval = state.beat === 16 ? 4 : (state.beat === 8 ? 8 : 16);
  if (cycleBeat % kickInterval === 0) playKick(time, state.drum);

  // ピアノ：コードチェンジ時
  if (cycleBeat % (total16ths / chords.length) === 0) {
    const f = getFreq(currentChord);
    if (f > 0) {
      playPiano(f, time, 1.0, state.drum);
      playPiano(f * (currentChord.includes("m") ? 1.189 : 1.259), time, 1.0, state.drum);
      playPiano(f * 1.498, time, 1.0, state.drum);
    }
  }

  // 行の切り替え
  if (cycleBeat === total16ths - 1) {
    let nextIdx = state.lines.findIndex((l, i) => i > state.currentLineIndex && l.loop);
    if (nextIdx === -1) nextIdx = state.lines.findIndex(l => l.loop);
    if (nextIdx !== -1) {
      state.currentLineIndex = nextIdx;
      // UI更新はメインスレッドで
      setTimeout(updateUIActive, 0);
    }
  }
}

function render() {
  const container = document.getElementById('line-container');
  const addBtn = document.getElementById('add-btn');
  container.querySelectorAll('.line-row').forEach(r => r.remove());

  state.lines.forEach((line, idx) => {
    const row = document.createElement('div');
    row.className = 'line-row';
    if (idx === state.currentLineIndex && state.isPlaying) row.classList.add('playing');
    
    const lBtn = document.createElement('div');
    lBtn.className = `loop-btn ${line.loop ? 'active' : ''}`;
    lBtn.onclick = () => { line.loop = !line.loop; render(); };

    const pWrap = document.createElement('div'); pWrap.className = 'part-wrapper';
    const pSel = document.createElement('select'); pSel.className = 'part-select';
    PARTS.forEach(p => pSel.add(new Option(p, p))); pSel.value = line.part;
    pSel.onchange = (e) => line.part = e.target.value;
    pWrap.appendChild(pSel);

    const cWrap = document.createElement('div'); cWrap.className = 'chord-wrapper';
    const cIn = document.createElement('input'); cIn.className = 'chords-input';
    cIn.value = line.chords;
    cIn.onchange = (e) => { 
      line.chords = e.target.value; 
      const match = ALL_TEMPLATES.find(t => applyTemplate(t.deg) === line.chords);
      line.templateName = match ? match.name : "Custom";
      line.templateDeg = match ? match.deg : "---";
      line.templateUsage = match ? match.usage : "オリジナル";
      render(); 
    };
    cWrap.appendChild(cIn);

    const tDisp = document.createElement('div'); tDisp.className = 'template-display';
    tDisp.innerHTML = `<div class="td-name">${line.templateName}</div><div class="td-deg">${line.templateDeg}</div><div class="td-usage">${line.templateUsage}</div>`;
    tDisp.onclick = () => showModal(idx);

    const dBtn = document.createElement('div'); dBtn.className = 'del-btn'; dBtn.textContent = '×';
    dBtn.onclick = () => { if(state.lines.length > 1) { state.lines.splice(idx, 1); render(); } };

    row.append(lBtn, pWrap, cWrap, tDisp, dBtn);
    container.insertBefore(row, addBtn);
  });
}

function updateUIActive() {
  document.querySelectorAll('.line-row').forEach((el, i) => {
    el.classList.toggle('playing', i === state.currentLineIndex);
  });
}

function showModal(lineIdx) {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  content.innerHTML = '<div class="modal-title">Template Select</div>';
  TEMPLATE_CATEGORIES.forEach(cat => {
    const section = document.createElement('div'); section.className = 'modal-section'; section.textContent = cat.cat;
    content.appendChild(section);
    cat.list.forEach(t => {
      const item = document.createElement('div'); item.className = 'modal-item';
      item.innerHTML = `<div class="m-name">${t.name}</div><div class="m-deg">${t.deg}</div><div class="m-usage">${t.usage}</div>`;
      item.onclick = () => {
        const l = state.lines[lineIdx];
        l.templateName = t.name; l.templateDeg = t.deg; l.templateUsage = t.usage;
        l.chords = applyTemplate(t.deg);
        overlay.style.display = 'none'; render();
      };
      content.appendChild(item);
    });
  });
  overlay.style.display = 'flex';
  overlay.onclick = (e) => { if(e.target===overlay) overlay.style.display='none'; };
}

function applyTemplate(degStr) {
  return degStr.split("-").map(d => {
    let clean = d.replace(/m|dim|7|M7|sus4|aug|\/.*|b/g, "");
    let offset = DEG_TO_SEMITONE[clean] || 0;
    if (d.startsWith('b')) offset -= 1;
    let n = KEYS[(state.keyIndex + offset) % 12];
    if (d.includes("m") || ["vi","ii","iii"].includes(clean)) n += "m";
    return n;
  }).join("-");
}

document.getElementById('play-btn').onclick = async () => {
  initAudio();
  if (audioCtx.state === 'suspended') await audioCtx.resume();
  if (state.isPlaying) {
    state.isPlaying = false;
    clearInterval(schedulerInterval);
    document.getElementById('play-btn').className = "play-btn play";
    document.getElementById('play-btn').textContent = "PLAY";
    state.currentLineIndex = -1; updateUIActive();
  } else {
    state.isPlaying = true;
    state.currentLineIndex = state.lines.findIndex(l => l.loop);
    state.currentBeatGlobal = 0;
    state.nextNoteTime = audioCtx.currentTime + 0.1;
    document.getElementById('play-btn').className = "play-btn stop";
    document.getElementById('play-btn').textContent = "STOP";
    schedulerInterval = setInterval(scheduler, 25);
  }
};

document.getElementById('add-btn').onclick = () => {
  state.lines.push({ loop: false, part: "Aメロ", chords: "", templateName: "Custom", templateDeg: "---", templateUsage: "Select..." });
  render();
};

window.onload = () => {
  const b = document.getElementById('bpm-select'); for(let i=60;i<=200;i++) b.add(new Option(i,i)); b.value=state.bpm;
  const k = document.getElementById('key-select'); KEYS.forEach((n,i)=> k.add(new Option(n,i))); k.value=state.keyIndex;
  b.onchange = (e) => state.bpm = parseInt(e.target.value);
  k.onchange = (e) => { state.keyIndex = parseInt(e.target.value); render(); };
  document.getElementById('beat-select').onchange = (e) => state.beat = parseInt(e.target.value);
  document.getElementById('drum-select').onchange = (e) => state.drum = e.target.value;
  render();
};
</script>
</body>
</html>
