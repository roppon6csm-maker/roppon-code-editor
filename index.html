<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="screen-orientation" content="portrait">
<title>Roppon Code Editor</title>
<style>
* { box-sizing: border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body { background:#000; color:#fff; overflow:hidden; height:100vh; touch-action:none; }

#app { display:flex; flex-direction:column; height:100%; }

header { flex:0 0 12%; padding-top:env(safe-area-inset-top, 20px); background:#000; display:flex; flex-direction:column; align-items:center; }
.app-title { width:100%; text-align:center; font-size:clamp(4vw, 6vw, 32px); font-weight:900; letter-spacing:1px; color:#fff; padding:clamp(2vh, 3vh, 20px) 0 1.5vh 0; }

.header-content { width:96%; margin:0 auto; display:flex; justify-content:space-between; gap:clamp(1vw, 1.5vw, 12px); padding-bottom:1.8vh; flex:1; }
.setting-group { flex:1; background:#1a1a1a; border-radius:10px; position:relative; height:clamp(7vh, 8vh, 60px); display:flex; align-items:center; justify-content:center; min-width:0; }
.setting-label { 
  position:absolute; 
  top:-1.4vh; 
  left:50%; 
  transform:translateX(-50%); 
  font-size:clamp(2vw, 2.3vw, 14px); 
  color:#888; 
  font-weight:600; 
  background:#000; 
  padding:0 8px; 
  white-space:nowrap; 
  z-index:1;
}
.global-select { 
  width:90%; 
  height:80%; 
  font-size:clamp(4.5vw, 5.2vw, 28px); 
  font-weight:700; 
  text-align:center; 
  background:transparent; 
  color:inherit; 
  appearance:none; 
  border:none; 
}

/* Colors */
#bpm-select { color:#4CCFFF; }
#key-select { color:#FFD60A; }
#beat-select { color:#FF9F0A; }
#drum-select { color:#32D74B; }

/* List Header */
.col-headers { display:flex; color:#777; font-size:clamp(3vw, 3.4vw, 16px); font-weight:600; padding:1.2vh 4vw 0.6vh; background:#000; }
.col-headers > div { text-align:center; flex:1; }

/* Main List */
main { flex:1; overflow-y:auto; padding:0 3vw 28vh; -webkit-overflow-scrolling:touch; position:relative; }
main::-webkit-scrollbar { display:none; }

.line-row { display:flex; align-items:center; background:#111; border-radius:10px; margin-bottom:1vh; padding:1vh 2vw; min-height:7.2vh; transition: all 0.18s; }
.line-row.playing { border:2px solid #4CCFFF; box-shadow:0 0 24px #4CCFFFaa, 0 0 48px #4CCFFF44; background:#1a1a1a; }

/* Loop Button */
.loop-btn { width:7vw; height:7vw; border-radius:50%; border:3px solid #555; flex-shrink:0; margin-right:2.2vw; transition: all 0.18s; }
.loop-btn.active { background:#4CCFFF; border-color:#4CCFFF; box-shadow:0 0 28px #4CCFFF, 0 0 56px #4CCFFF88, inset 0 0 12px #ffffff66; }

/* Part Select */
.part-wrapper { position:relative; width:19%; height:100%; }
.part-wrapper select { width:100%; height:100%; font-size:3.3vw; font-weight:700; color:#fff; border:none; border-radius:8px; padding:0 2.5vw 0 1.2vw; appearance:none; text-align:center; cursor:pointer; }
.part-wrapper::after { content:'▼'; position:absolute; right:1.2vw; top:50%; transform:translateY(-50%); color:#fff; font-size:2.2vw; pointer-events:none; }

/* Part背景色 */
.part-Intro     select { background:#4682B4; }
.part-A         select { background:#FF8C00; }
.part-B         select { background:#32CD32; }
.part-Pre-Chorus select { background:#9932CC; }
.part-Chorus    select { background:#FF1493; }
.part-Interlude select { background:#00CED1; }
.part-C         select { background:#FFD700; }
.part-Outro     select { background:#A0522D; }

/* Chords */
.chord-wrapper { position:relative; width:37%; height:100%; }
.chords-input { width:100%; height:100%; background:#222; color:#4CCFFF; font-size:3.5vw; border:none; border-radius:8px; padding:0 5vw 0 1.5vw; }
.chords-input::placeholder { color:#555; font-size:2.8vw; }
.edit-icon { position:absolute; right:1.8vw; top:50%; transform:translateY(-50%); font-size:4.2vw; color:#4CCFFF; opacity:0.85; pointer-events:none; }

/* Template */
.template-wrapper { width:35%; height:100%; }
.template-wrapper select { width:100%; height:100%; background:#222; color:#ccc; font-size:3.1vw; border:none; border-radius:8px; padding:0 2.5vw 0 1.2vw; appearance:none; }

/* Add Button - main内に配置してタップしやすく */
#add-btn { 
  width:100%; 
  height:10vh; 
  background:none; 
  color:#666; 
  font-size:clamp(8vw, 12vw, 60px); 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  cursor:pointer; 
  font-weight:bold; 
  margin:1vh 0 2vh 0; 
  touch-action:manipulation; 
}
#add-btn:active { color:#aaa; }

/* Controls */
.controls-overlay { position:absolute; bottom:0; left:0; right:0; height:30vh; display:flex; flex-direction:column; align-items:center; justify-content:flex-end; background:linear-gradient(to top,#000 45%,transparent); pointer-events:none; padding-bottom:env(safe-area-inset-bottom, 20px); }
.page-dots { display:flex; gap:2.8vw; margin-bottom:5vh; }
.dot { width:1.6vw; height:1.6vw; border-radius:50%; background:#444; }
.dot.active { background:#4CCFFF; box-shadow:0 0 12px #4CCFFF; }

#play-btn { 
  pointer-events:auto; 
  width:26vw; 
  height:26vw; 
  border-radius:50%; 
  background:#34C759; 
  color:#fff; 
  font-size:5.8vw; 
  font-weight:900; 
  display:flex; 
  align-items:center; 
  justify-content:center; 
  box-shadow:0 10px 30px #000A, 0 0 40px #34C75988; 
  margin-bottom:clamp(6vh, 8vh, 50px); 
  transition:transform 0.12s; 
}
#play-btn.stop { background:#FF3B30; box-shadow:0 10px 30px #000A, 0 0 40px #FF3B3088; }
#play-btn:active { transform:scale(0.92); }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="app-title">Roppon Code Editor</div>
    <div class="header-content">
      <div class="setting-group">
        <div class="setting-label">BPM</div>
        <select id="bpm-select" class="global-select"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label">KEY</div>
        <select id="key-select" class="global-select"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label">BEAT</div>
        <select id="beat-select" class="global-select">
          <option value="4">4</option>
          <option value="8" selected>8</option>
          <option value="16">16</option>
        </select>
      </div>
      <div class="setting-group">
        <div class="setting-label">DRUM</div>
        <select id="drum-select" class="global-select">
          <option value="1" selected>METRO</option>
          <option value="2">BASIC</option>
          <option value="3">HOUSE</option>
          <option value="4">ROCK8</option>
          <option value="5">DANCE16</option>
        </select>
      </div>
    </div>
  </header>

  <div class="col-headers">
    <div class="col-h-loop">roop</div>
    <div class="col-h-part">Part</div>
    <div class="col-h-chord">Chords</div>
    <div class="col-h-tmpl">Template</div>
  </div>

  <main id="line-container">
    <!-- Lines injected here -->
  </main>

  <div id="add-btn">+</div>

  <div class="controls-overlay">
    <div class="page-dots">
      <div class="dot"></div>
      <div class="dot"></div>
      <div class="dot active"></div>
      <div class="dot"></div>
    </div>
    <div id="play-btn" class="play">PLAY</div>
  </div>
</div>

<script>
// --- スクリプト（テンプレート配列含む完全版） ---
// (ここに以前の完全スクリプトを全て貼り付け。TEMPLATES配列が確実に定義されていることを確認)

// 例: TEMPLATES配列（抜けていると空になるので必ず入れる）
const TEMPLATES = [
  { name: "王道進行", deg: ["I", "V", "vi", "IV"], usage: "サビ最頻出" },
  { name: "マイナー王道", deg: ["vi", "IV", "I", "V"], usage: "切な系サビ" },
  // ... 他のテンプレートも全て
  { name: "エモ進行", deg: ["vi", "I", "V", "IV"], usage: "エモい" }
];

// populateSelects, renderLine, refreshUI など全て前回と同じ

// +ボタンイベントを強化（touchstartも追加）
document.getElementById('add-btn').addEventListener('click', addLine);
document.getElementById('add-btn').addEventListener('touchstart', (e) => {
  e.preventDefault(); // ダブルタップズーム防止
  addLine();
});

// ラベル中央寄せを保証
document.querySelectorAll('.setting-label').forEach(label => {
  label.style.left = '50%';
  label.style.transform = 'translateX(-50%)';
});
</script>
</body>
</html>
