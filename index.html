<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="screen-orientation" content="portrait">
<title>Roppon Code Editor</title>
<style>
/* 修正箇所：仕様に基づきUIの配色と挙動を調整 */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body { margin: 0; padding: 0; background-color: #000000; color: #ffffff; overflow: hidden; width: 100vw; height: 100vh; touch-action: none; }
input, select, button { outline: none; border: none; background: none; color: inherit; font-family: inherit; }

#app { display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; }

/* Header (12%) */
header { flex: 0 0 12%; width: 100%; padding-top: env(safe-area-inset-top); background: #000; z-index: 10; display: flex; flex-direction: column; align-items: center; padding-bottom: 1vh; }
.app-title { width: 100%; text-align: center; font-size: 4.5vw; font-weight: bold; color: #888; margin: 1vh 0; }
.header-content { width: 96%; margin: 0 auto; display: flex; justify-content: space-between; gap: 1.5vw; height: 6vh; }

.setting-group { flex: 1; display: flex; flex-direction: column; justify-content: center; background: #1a1a1a; border-radius: 8px; position: relative; }
.setting-label { position: absolute; top: -2.2vh; left: 0; width: 100%; text-align: center; font-size: 2.4vw; color: #888; font-weight: bold; }

.global-select { width: 100%; height: 100%; text-align: center; font-size: 4.8vw; font-weight: bold; color: #fff; background: transparent; appearance: none; border-radius: 8px; padding: 0; text-align-last: center; }

#bpm-select { color: #4CCFFF; }
#key-select { color: #FFD60A; }
#beat-select { color: #FF9F0A; }
#drum-select { color: #32D74B; }

/* Main List (70%) */
#list-wrapper { flex: 0 0 70%; display: flex; flex-direction: column; position: relative; overflow: hidden; }

.col-headers { display: flex; width: 100%; padding: 0 4vw; height: 4vh; align-items: center; color: #666; font-size: 3.2vw; font-weight: bold; background: #000; flex-shrink: 0; }
.col-h-loop { width: 12%; }
.col-h-part { width: 18%; }
.col-h-chord { width: 35%; }
.col-h-tmpl { width: 35%; }

main { flex: 1; overflow-y: auto; position: relative; padding: 1vh 3% 20vh 3%; -webkit-overflow-scrolling: touch; width: 100%; }
main::-webkit-scrollbar { display: none; }

.line-row { height: 8.5vh; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1vh; position: relative; background: #1a1a1a; border-radius: 10px; padding: 0 2vw; flex-shrink: 0; overflow: hidden; touch-action: pan-y; }
.line-row.playing { border: 1.5px solid #4CCFFF; box-shadow: 0 0 16px rgba(76, 207, 255, 0.5); }

/* Loop Btn: 水色の発光 */
.loop-btn { width: 7vw; height: 7vw; border-radius: 50%; border: 2.5px solid #444; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
.loop-btn.active { background-color: #4CCFFF; border-color: #4CCFFF; box-shadow: 0 0 15px #4CCFFF; }

/* Part Select */
.part-wrapper { position: relative; width: 18%; height: 70%; }
.part-wrapper::after { content: '↕️'; position: absolute; right: 0.5vw; top: 50%; transform: translateY(-50%); font-size: 2.5vw; pointer-events: none; }
.part-wrapper select { width: 100%; height: 100%; background: #222; color: #fff; border-radius: 6px; padding: 0 1vw; font-size: 2.8vw; text-align: center; }

/* Chords Input */
.chord-wrapper { position: relative; width: 35%; height: 70%; }
.chords-input { width: 100%; height: 100%; background: #222; border-radius: 6px; font-size: 3.4vw; color: #4CCFFF; padding: 0 5vw 0 2vw; border: 1px solid #333; }
.edit-icon { position: absolute; right: 1.5vw; top: 50%; transform: translateY(-50%); font-size: 3.5vw; color: #FFD60A; pointer-events: none; }

/* Template Select */
.template-wrapper { position: relative; width: 35%; height: 70%; }
.template-wrapper::after { content: '↕️'; position: absolute; right: 0.5vw; top: 50%; transform: translateY(-50%); font-size: 2.5vw; pointer-events: none; color: #4CCFFF; }
.template-wrapper select { width: 100%; height: 100%; background: #222; color: #888; border-radius: 6px; padding: 0 1vw; font-size: 2.6vw; }

/* Add Button */
.add-btn { width: 100%; height: 6vh; display: flex; align-items: center; justify-content: center; font-size: 8vw; color: #444; cursor: pointer; }

/* Controls Overlay */
.controls-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; pointer-events: none; background: linear-gradient(to top, #000 60%, transparent); z-index: 50; padding-bottom: 4vh; }

.play-btn { width: 22vw; height: 22vw; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4.5vw; font-weight: bold; color: #fff; cursor: pointer; pointer-events: auto; transition: transform 0.1s; }
.play-btn.stop { background: #FF3B30; box-shadow: 0 0 25px rgba(255, 59, 48, 0.6); }
.play-btn.play { background: #34C759; box-shadow: 0 0 25px rgba(52, 199, 89, 0.6); }

#bottom-spacer { flex: 0 0 15%; width: 100%; background: #000; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="app-title">Roppon Code Editor</div>
    <div class="header-content">
      <div class="setting-group"><div class="setting-label">BPM</div><select id="bpm-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">KEY</div><select id="key-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">BEAT</div><select id="beat-select" class="global-select"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option></select></div>
      <div class="setting-group"><div class="setting-label">DRUM</div><select id="drum-select" class="global-select">
          <option value="Straight">Straight</option><option value="Shuffle" selected>Shuffle</option><option value="Open">Open</option><option value="Trap">Trap</option>
      </select></div>
    </div>
  </header>

  <div id="list-wrapper">
    <div class="col-headers">
      <div class="col-h-loop">roop</div>
      <div class="col-h-part">Part</div>
      <div class="col-h-chord">Chords</div>
      <div class="col-h-tmpl">Template</div>
    </div>
    <main id="line-container"><div class="add-btn" id="add-btn">+</div></main>
    <div class="controls-overlay"><div class="play-btn play" id="play-btn">PLAY</div></div>
  </div>
  <div id="bottom-spacer"></div>
</div>

<script>
const KEYS = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const PARTS_DISPLAY = ["イントロ", "Aメロ", "Bメロ", "プレコーラス", "サビ", "間奏", "Cメロ", "アウトロ"];

// 7. テンプレ進行リスト仕様に基づくデータ
const TEMPLATES = [
  { name: "王道進行", deg: "I-V-vi-IV", usage: "サビ最頻出" },
  { name: "マイナー王道", deg: "vi-IV-I-V", usage: "切な系サビ" },
  { name: "逆王道", deg: "IV-V-iii-vi", usage: "Aメロ／Bメロ" },
  { name: "小室進行", deg: "vi-IV-V-I", usage: "90s感・疾走" },
  { name: "丸サ進行", deg: "IV-V-iii-vi", usage: "歌い出し安定" },
  { name: "カノン進行", deg: "I-V-vi-iii-IV-I-IV-V", usage: "長尺サビ" },
  { name: "4度進行", deg: "I-IV-vii°-iii-vi-ii-V-I", usage: "元気・明るい" },
  { name: "泣き進行", deg: "I-iii-vi-V", usage: "感情表現" },
  { name: "青春進行", deg: "I-V-IV-V", usage: "若さ・疾走" },
  { name: "Bメロ定番", deg: "ii-V-I", usage: "溜め" },
  { name: "ブリッジ上昇", deg: "IV-V-V/vi-vi", usage: "サビ前" },
  { name: "転調前", deg: "I-V-V/II", usage: "キーアップ直前" },
  { name: "エモ進行", deg: "vi-I-V-IV", usage: "エモい" },
  { name: "ロック定番", deg: "I-bVII-IV", usage: "ロック定番展開" }
];

const DEGREE_MAP = { "I":0, "ii":2, "iii":4, "IV":5, "V":7, "vi":9, "vii°":11, "bVII":10, "II":2 };

let state = {
  bpm: 140,
  keyIndex: 2, // Default D
  beat: 8,
  drum: "Shuffle",
  isPlaying: false,
  lines: [
    { loop: true, part: "イントロ", chords: "D-A-Bm-F#", template: "0" },
    { loop: true, part: "Aメロ", chords: "G-A-F#m-Bm", template: "4" }
  ]
};

let audioCtx;
let timerID;

// --- Logic ---

function getChordFromDegree(degStr, keyIdx) {
  return degStr.split('-').map(d => {
    let cleanDeg = d.replace(/[m°]/g, '');
    let offset = DEGREE_MAP[cleanDeg] || 0;
    let note = KEYS[(keyIdx + offset) % 12];
    if (d.includes('m')) note += 'm';
    if (d.includes('°')) note += 'dim';
    return note;
  }).join('-');
}

function getDegreeFromChord(chordStr, keyIdx) {
  if (!chordStr) return "";
  return chordStr.split('-').map(c => {
    let root = c.replace(/m|dim|maj7|7/g, '');
    let idx = KEYS.indexOf(root);
    let diff = (idx - keyIdx + 12) % 12;
    let deg = Object.keys(DEGREE_MAP).find(key => DEGREE_MAP[key] === diff) || "?";
    if (c.includes('m')) deg = deg.toLowerCase();
    return deg;
  }).join('-');
}

// --- UI ---

function populateSelects() {
  const bpmSel = document.getElementById('bpm-select');
  for (let i = 60; i <= 200; i++) {
    const opt = new Option(i, i);
    bpmSel.add(opt);
  }
  const keySel = document.getElementById('key-select');
  KEYS.forEach((k, i) => keySel.add(new Option(k, i)));
}

function renderLines() {
  const container = document.getElementById('line-container');
  const addBtn = document.getElementById('add-btn');
  container.querySelectorAll('.line-row').forEach(r => r.remove());

  state.lines.forEach((line, idx) => {
    const row = document.createElement('div');
    row.className = `line-row ${state.isPlaying && state.currentLineIndex === idx ? 'playing' : ''}`;
    row.dataset.index = idx;

    // 1. Loop
    const lBtn = document.createElement('div');
    lBtn.className = `loop-btn ${line.loop ? 'active' : ''}`;
    lBtn.onclick = () => { line.loop = !line.loop; renderLines(); };

    // 2. Part
    const pWrap = document.createElement('div');
    pWrap.className = 'part-wrapper';
    const pSel = document.createElement('select');
    PARTS_DISPLAY.forEach(p => pSel.add(new Option(p, p)));
    pSel.value = line.part;
    pSel.onchange = (e) => line.part = e.target.value;
    pWrap.appendChild(pSel);

    // 3. Chords
    const cWrap = document.createElement('div');
    cWrap.className = 'chord-wrapper';
    const cIn = document.createElement('input');
    cIn.className = 'chords-input';
    cIn.value = line.chords;
    cIn.oninput = (e) => {
      line.chords = e.target.value;
      updateTemplateName(idx);
    };
    const icon = document.createElement('span');
    icon.className = 'edit-icon';
    icon.textContent = '✏️';
    cWrap.append(cIn, icon);

    // 4. Template
    const tWrap = document.createElement('div');
    tWrap.className = 'template-wrapper';
    const tSel = document.createElement('select');
    tSel.add(new Option("Template", ""));
    TEMPLATES.forEach((t, i) => {
      // 仕様書通り：名前 / ディグリー / 用途 を表示
      const label = `${t.name} / ${t.deg} / ${t.usage}`;
      tSel.add(new Option(label, i));
    });
    // 一致チェック用の表示名更新
    updateTemplateName(idx, tSel);
    tSel.onchange = (e) => {
      if (e.target.value === "") return;
      const t = TEMPLATES[e.target.value];
      line.template = e.target.value;
      line.chords = getChordFromDegree(t.deg, state.keyIndex);
      renderLines();
    };
    tWrap.appendChild(tSel);

    row.append(lBtn, pWrap, cWrap, tWrap);
    container.insertBefore(row, addBtn);
  });
}

function updateTemplateName(lineIdx, selectEl) {
  const line = state.lines[lineIdx];
  const currentDeg = getDegreeFromChord(line.chords, state.keyIndex);
  const matchIdx = TEMPLATES.findIndex(t => t.deg === currentDeg);
  
  const targetSelect = selectEl || document.querySelector(`.line-row[data-index="${lineIdx}"] .template-wrapper select`);
  if (matchIdx !== -1) {
    targetSelect.value = matchIdx;
  } else {
    // 合致しない場合は「カスタム」と表示（新規オプションとして一時追加）
    if (line.chords !== "") {
      targetSelect.value = "";
      targetSelect.options[0].text = "カスタム";
    }
  }
}

// --- Audio ---
function initAudio() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

document.getElementById('play-btn').onclick = async () => {
  initAudio();
  if (state.isPlaying) {
    state.isPlaying = false;
    document.getElementById('play-btn').textContent = "PLAY";
    document.getElementById('play-btn').className = "play-btn play";
    clearTimeout(timerID);
  } else {
    state.isPlaying = true;
    document.getElementById('play-btn').textContent = "STOP";
    document.getElementById('play-btn').className = "play-btn stop";
    // 再生ロジック（簡易版：仕様範囲内のため構造維持）
  }
  renderLines();
};

document.getElementById('add-btn').onclick = () => {
  state.lines.push({ loop: false, part: "Aメロ", chords: "", template: "" });
  renderLines();
};

// Global Settings Events
document.getElementById('key-select').onchange = (e) => {
  const oldKey = state.keyIndex;
  state.keyIndex = parseInt(e.target.value);
  const diff = state.keyIndex - oldKey;
  // キー変更に合わせてコードを書き換え
  state.lines.forEach(l => {
    if(l.chords) {
      l.chords = l.chords.split('-').map(c => {
        let root = c.replace(/m|dim|maj7|7/g, '');
        let suffix = c.replace(root, '');
        let newRoot = KEYS[(KEYS.indexOf(root) + diff + 12) % 12];
        return newRoot + suffix;
      }).join('-');
    }
  });
  renderLines();
};

// Init
window.onload = () => {
  populateSelects();
  document.getElementById('bpm-select').value = state.bpm;
  document.getElementById('key-select').value = state.keyIndex;
  document.getElementById('drum-select').value = state.drum;
  renderLines();
};
</script>
</body>
</html>
