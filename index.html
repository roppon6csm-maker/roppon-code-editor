<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="screen-orientation" content="portrait">
<title>Roppon Code Editor</title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
body { margin: 0; padding: 0; background-color: #000; color: #fff; overflow: hidden; width: 100vw; height: 100vh; touch-action: none; }
input, select, button { outline: none; border: none; background: none; color: inherit; font-family: inherit; }

#app { display: flex; flex-direction: column; width: 100%; height: 100%; overflow: hidden; }

header { flex: 0 0 10%; width: 100%; padding-top: env(safe-area-inset-top); background: #000; display: flex; align-items: flex-end; padding-bottom: 1vh; }
.header-content { width: 96%; margin: 0 auto; height: 70%; display: flex; justify-content: space-between; gap: 1vw; }

.setting-group { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; background: #1a1a1a; border-radius: 6px; position: relative; height: 100%; }
.setting-label { position: absolute; top: -2vh; left: 0; width: 100%; text-align: center; font-size: 2.5vw; color: #888; font-weight: bold; }

.global-select { width: 100%; height: 100%; text-align: center; font-size: 4.5vw; font-weight: bold; color: #fff; background: transparent; appearance: none; border-radius: 6px; padding: 0; text-align-last: center; }
.global-select:focus { background: #222; }

#bpm-select { color: #4CCFFF; }
#key-select { color: #FFD60A; }
#beat-select { color: #FF9F0A; }
#hat-select { color: #32D74B; }

#list-wrapper { flex: 0 0 70%; display: flex; flex-direction: column; position: relative; overflow: hidden; }

.col-headers { display: flex; width: 100%; padding: 0 4vw; height: 4vh; align-items: center; color: #666; font-size: 3vw; font-weight: bold; background: #000; flex-shrink: 0; }
.col-h-part { width: 18%; margin-left: 8%; }
.col-h-chord { width: 45%; margin-left: 2%; }
.col-h-temp { width: 30%; margin-left: 2%; }

main { flex: 1; overflow-y: auto; position: relative; padding: 1vh 3% 18vh 3%; -webkit-overflow-scrolling: touch; width: 100%; }
main::-webkit-scrollbar { display: none; }

.line-row { height: 12vh; display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5vh; position: relative; background: #111; border-radius: 8px; padding: 0 1vw; transition: background 0.2s; flex-shrink: 0; }
.line-row.playing { border: 1px solid #4CCFFF; box-shadow: 0 0 10px rgba(76, 207, 255, 0.3); }

.loop-btn { width: 6vw; height: 6vw; border-radius: 50%; border: 2px solid #444; margin-left: 1vw; cursor: pointer; transition: all 0.2s; flex-shrink: 0; }
.loop-btn.active { background-color: #4CCFFF; border-color: #4CCFFF; box-shadow: 0 0 8px #4CCFFF; }

.part-wrapper { position: relative; width: 18%; height: 80%; }
.part-wrapper::after { content: '▼'; position: absolute; right: 0.5vw; top: 50%; transform: translateY(-50%); font-size: 1.8vw; color: #4CCFFF; pointer-events: none; }
.part-wrapper select { width: 100%; height: 100%; background: #222; color: #fff; border-radius: 4px; padding: 0 1.5vw 0 0.5vw; font-size: 2.8vw; }

.chords-input { width: 45%; height: 80%; background: #222; border-radius: 4px; font-size: 3.5vw; color: #fff; padding: 0 2vw; border: 1px solid #333; }
.chords-input::placeholder { color: #555; font-size: 2.5vw; }

.template-wrapper { position: relative; width: 30%; height: 80%; }
.template-wrapper::after { content: '▼'; position: absolute; right: 0.5vw; top: 50%; transform: translateY(-50%); font-size: 1.8vw; color: #4CCFFF; pointer-events: none; }
.template-wrapper select { width: 100%; height: 100%; background: #222; color: #aaa; border-radius: 4px; padding: 0 1.5vw 0 0.5vw; font-size: 2.2vw; }

.add-btn { width: 100%; height: 8vh; background: none; color: #666; font-size: 8vw; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; margin-top: 1vh; flex-shrink: 0; }
.add-btn:active { color: #fff; }

.controls-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; pointer-events: none; background: linear-gradient(to top, #000 40%, transparent); z-index: 50; padding-bottom: 2vh; }

.page-dots { display: flex; gap: 1.5vw; margin-bottom: 3vh; }
.dot { width: 1.2vw; height: 1.2vw; border-radius: 50%; background: #333; }
.dot.active { background: #4CCFFF; }

.play-btn { width: 20vw; height: 20vw; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4vw; font-weight: bold; color: #fff; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: transform 0.1s; pointer-events: auto; z-index: 51; }
.play-btn.stop { background: #FF3B30; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); }
.play-btn.play { background: #34C759; box-shadow: 0 0 20px rgba(52, 199, 89, 0.4); }
.play-btn:active { transform: scale(0.95); }

#bottom-spacer { flex: 0 0 20%; width: 100%; background: #000; padding-bottom: env(safe-area-inset-bottom); }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="header-content">
      <div class="setting-group">
        <div class="setting-label">BPM</div>
        <select id="bpm-select" class="global-select"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label">KEY</div>
        <select id="key-select" class="global-select"></select>
      </div>
      <div class="setting-group">
        <div class="setting-label">BEAT</div>
        <select id="beat-select" class="global-select">
          <option value="4">4</option>
          <option value="8" selected>8</option>
          <option value="16">16</option>
        </select>
      </div>
      <div class="setting-group">
        <div class="setting-label">HAT</div>
        <select id="hat-select" class="global-select">
          <option value="1" selected>Straight</option>
          <option value="2">Shuffle</option>
          <option value="3">Open</option>
          <option value="4">Trap</option>
        </select>
      </div>
    </div>
  </header>

  <div id="list-wrapper">
    <div class="col-headers">
      <div style="width: 7%"></div>
      <div class="col-h-part">Part</div>
      <div class="col-h-chord">Chords</div>
      <div class="col-h-temp">Template</div>
    </div>
    <main id="line-container">
      <div class="add-btn" id="add-btn">+</div>
    </main>
    <div class="controls-overlay">
      <div class="page-dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot active"></div>
        <div class="dot"></div>
      </div>
      <div class="play-btn play" id="play-btn">PLAY</div>
    </div>
  </div>
  <div id="bottom-spacer"></div>
</div>

<script>
const KEYS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
const PARTS = ["Intro","A","B","Pre-Chorus","Chorus","Interlude","C","Outro"];
const PARTS_DISPLAY = ["イントロ","Aメロ","Bメロ","プレコーラス","サビ","間奏","Cメロ","アウトロ"];
const TEMPLATES = [
  { name:"王道進行", deg:["I","V","vi","IV"], usage:"サビ最頻出" },
  { name:"マイナー王道", deg:["vi","IV","I","V"], usage:"切な系サビ" },
  { name:"逆王道", deg:["IV","V","iii","vi"], usage:"A・Bメロ" },
  { name:"小室進行", deg:["vi","IV","V","I"], usage:"90s疾走" },
  { name:"丸サ進行", deg:["IV","V","iii","vi"], usage:"歌い出し" },
  { name:"カノン進行", deg:["I","V","vi","iii","IV","I","IV","V"], usage:"バラード" },
  { name:"4度進行", deg:["I","IV","V","I"], usage:"明るい" },
  { name:"泣き進行", deg:["I","iii","vi","V"], usage:"感動" },
  { name:"青春進行", deg:["I","V","IV","V"], usage:"爽やか" },
  { name:"Bメロ定番", deg:["ii","V","I"], usage:"解決感" },
  { name:"ロック定番", deg:["I","bVII","IV"], usage:"洋楽風" },
  { name:"エモ進行", deg:["vi","I","V","IV"], usage:"エモい" }
];
const DEGREE_MAP={I:0,II:2,ii:2,III:4,iii:4,IV:5,V:7,VI:9,vi:9,VII:11,bVII:10};
let state={bpm:120,keyIndex:0,beat:8,hat:1,isPlaying:false,lines:[],currentLineIndex:-1,nextNoteTime:0,currentBeat:0};
let audioCtx, keepAliveOsc=null;

const bpmSelect=document.getElementById('bpm-select');
const keySelect=document.getElementById('key-select');
const beatSelect=document.getElementById('beat-select');
const hatSelect=document.getElementById('hat-select');
const playBtn=document.getElementById('play-btn');
const container=document.getElementById('line-container');

bpmSelect.innerHTML=Array.from({length:201},(_,i)=>`<option value="${i+40}" ${i+40===state.bpm?'selected':''}>${i+40}</option>`).join('');
keySelect.innerHTML=KEYS.map((k,i)=>`<option value="${i}" ${i===state.keyIndex?'selected':''}>${k}</option>`).join('');

bpmSelect.onchange=e=>state.bpm=parseInt(e.target.value);
keySelect.onchange=e=>state.keyIndex=parseInt(e.target.value);
beatSelect.onchange=e=>state.beat=parseInt(e.target.value);
hatSelect.onchange=e=>state.hat=parseInt(e.target.value);

document.getElementById('add-btn').onclick=()=>{
  const newLine={id:Date.now(),loop:false,part:"Intro",chords:"",template:""};
  state.lines.push(newLine);
  renderAllLines();
};

function renderLine(line,index){
  const div=document.createElement('div');
  div.className='line-row';
  div.dataset.index=index;

  const loopBtn=document.createElement('div');
  loopBtn.className=`loop-btn ${line.loop?'active':''}`;
  loopBtn.onclick=()=>{state.lines[index].loop=!state.lines[index].loop; renderAllLines();};

  const partWrap=document.createElement('div'); partWrap.className='part-wrapper';
  const partSel=document.createElement('select');
  partSel.innerHTML=PARTS.map((p,i)=>`<option value="${p}" ${p===line.part?'selected':''}>${PARTS_DISPLAY[i]}</option>`).join('');
  partSel.onchange=e=>state.lines[index].part=e.target.value;
  partWrap.appendChild(partSel);

  const chordIn=document.createElement('input'); chordIn.className='chords-input';
  chordIn.value=line.chords||''; chordIn.oninput=e=>state.lines[index].chords=e.target.value;

  const tempWrap=document.createElement('div'); tempWrap.className='template-wrapper';
  const tempSel=document.createElement('select');
  tempSel.innerHTML=TEMPLATES.map((t,i)=>`<option value="${i}" ${i==line.template?'selected':''}>${t.name}</option>`).join('');
  tempSel.onchange=e=>{
    state.lines[index].template=parseInt(e.target.value);
    state.lines[index].chords=generateChordsFromTemplate(e.target.value,state.keyIndex);
    renderAllLines();
  }
  tempWrap.appendChild(tempSel);

  div.appendChild(loopBtn); div.appendChild(partWrap); div.appendChild(chordIn); div.appendChild(tempWrap);
  return div;
}

function renderAllLines(){container.innerHTML=''; state.lines.forEach((l,i)=>container.appendChild(renderLine(l,i))); container.appendChild(document.getElementById('add-btn'));}

function getNoteFromKey(degree,keyIndex){
  let offset=DEGREE_MAP[degree]||0;
  let noteIndex=(keyIndex+offset)%12;
  let noteName=KEYS[noteIndex]; let quality="";
  if(degree==="ii"||degree==="iii"||degree==="vi") quality="m";
  if(degree.match(/^[a-z]/)&&degree!=="bVII") quality="m";
  return noteName+quality;
}

function generateChordsFromTemplate(templateIndex,keyIndex){
  if(templateIndex==="") return "";
  const tmpl=TEMPLATES[templateIndex]; if(!tmpl) return "";
  return tmpl.deg.map(d=>getNoteFromKey(d,keyIndex)).join("-");
}

// --- Audio ---
function initAudio(){if(!audioCtx){audioCtx=new(window.AudioContext||window.webkitAudioContext)();}}

function playHAT(time){
  const osc=audioCtx.createOscillator();
  const filter=audioCtx.createBiquadFilter();
  const gainNode=audioCtx.createGain();
  osc.type='square'; osc.frequency.setValueAtTime(8000,time);
  filter.type='highpass'; filter.frequency.setValueAtTime(2000,time);
  gainNode.gain.setValueAtTime(0.05,time);
  osc.connect(filter); filter.connect(gainNode); gainNode.connect(audioCtx.destination);
  osc.start(time); osc.stop(time+0.05);
}

// --- Play Control ---
playBtn.onclick=async ()=>{
  initAudio();
  await audioCtx.resume(); // iOS対策
  state.isPlaying=!state.isPlaying;
  playBtn.className=state.isPlaying?'play-btn stop':'play-btn play';
  playBtn.textContent=state.isPlaying?'STOP':'PLAY';
}

</script>
</body>
</html>
