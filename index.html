<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Roppon Code Editor Ver.2.2</title>
<style>
/* 1. 全体設定 */
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; font-family: -apple-system, sans-serif; }
body { margin: 0; padding: 0; background-color: #000; color: #fff; overflow: hidden; width: 100vw; height: 100vh; }
input, select, button { outline: none; border: none; background: none; color: inherit; }

#app { display: flex; flex-direction: column; width: 100%; height: 100%; }

/* 2. ヘッダー：重なりを完全に排除 */
header { flex: 0 0 auto; width: 100%; padding: env(safe-area-inset-top) 0 10px 0; background: #000; display: flex; flex-direction: column; align-items: center; border-bottom: 1px solid #222; }
.app-title { font-size: 4.5vw; font-weight: bold; color: #888; margin: 12px 0; }
.header-settings { width: 94%; display: flex; justify-content: space-between; gap: 1.5vw; }

.setting-group { flex: 1; display: flex; flex-direction: column; align-items: center; background: #1a1a1a; border-radius: 10px; padding: 6px 0; border: 1px solid #333; }
.setting-label { font-size: 2.2vw; color: #666; margin-bottom: 2px; font-weight: bold; text-transform: uppercase; }
.global-select { width: 100%; text-align: center; font-size: 4vw; font-weight: bold; appearance: none; text-align-last: center; }

#bpm-select { color: #4CCFFF; }
#key-select { color: #FFD60A; }
#beat-select { color: #FF9F0A; }
#drum-select { color: #32D74B; }

/* 3. リストエリア */
#list-wrapper { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
.col-headers { display: flex; width: 100%; padding: 8px 4vw 4px 4vw; color: #444; font-size: 2.5vw; font-weight: bold; text-transform: uppercase; }
.col-h-loop { width: 8%; } .col-h-part { width: 16%; } .col-h-chord { width: 32%; } .col-h-tmpl { width: 34%; } .col-h-del { width: 10%; }

main { flex: 1; overflow-y: auto; padding: 0 3% 25vh 3%; -webkit-overflow-scrolling: touch; }
main::-webkit-scrollbar { display: none; }

.line-row { height: 10vh; display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; background: #111; border-radius: 12px; padding: 0 2vw; border: 1px solid #222; }
.line-row.playing { border: 2px solid #4CCFFF; box-shadow: 0 0 15px rgba(76, 207, 255, 0.4); }

.loop-btn { width: 6.5vw; height: 6.5vw; border-radius: 50%; border: 2px solid #333; transition: 0.2s; }
.loop-btn.active { background-color: #4CCFFF; border-color: #4CCFFF; box-shadow: 0 0 10px #4CCFFF; }

.part-wrapper { width: 16%; height: 70%; background: #222; border-radius: 6px; }
.part-select { width: 100%; height: 100%; font-size: 2.6vw; text-align: center; }

.chord-wrapper { width: 32%; height: 70%; position: relative; }
.chords-input { width: 100%; height: 100%; background: #222; border-radius: 6px; font-size: 3.2vw; color: #4CCFFF; padding: 0 5px; border: 1px solid #333; text-align: center; }

/* テンプレート3行表示 */
.template-display { width: 34%; height: 85%; background: #1a1a1a; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; padding: 0 6px; border: 1px solid #333; overflow: hidden; }
.td-name { font-size: 2.6vw; font-weight: bold; color: #fff; white-space: nowrap; }
.td-deg { font-size: 2vw; color: #4CCFFF; }
.td-usage { font-size: 1.8vw; color: #555; white-space: nowrap; }

/* 削除ボタン */
.del-btn { width: 8vw; height: 8vw; display: flex; align-items: center; justify-content: center; color: #444; font-size: 5vw; font-weight: bold; }
.del-btn:active { color: #FF3B30; }

/* モーダル */
#modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
#modal-content { width: 85%; max-height: 70%; background: #1a1a1a; border-radius: 15px; overflow-y: auto; padding: 15px; border: 1px solid #333; }
.modal-item { background: #222; margin-bottom: 8px; padding: 12px; border-radius: 10px; border: 1px solid #444; }

/* コントロール */
.controls-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 25%; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; background: linear-gradient(to top, #000 80%, transparent); }
.add-btn { width: 12vw; height: 12vw; color: #444; font-size: 10vw; display: flex; align-items: center; justify-content: center; margin-bottom: 2vh; pointer-events: auto; }
.play-btn { width: 22vw; height: 22vw; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 4.5vw; font-weight: bold; pointer-events: auto; }
.play-btn.play { background: #34C759; box-shadow: 0 0 20px rgba(52, 199, 89, 0.4); }
.play-btn.stop { background: #FF3B30; box-shadow: 0 0 20px rgba(255, 59, 48, 0.4); }

#bottom-spacer { flex: 0 0 10%; background: #000; }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="app-title">Roppon Code Editor</div>
    <div class="header-settings">
      <div class="setting-group"><div class="setting-label">BPM</div><select id="bpm-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">KEY</div><select id="key-select" class="global-select"></select></div>
      <div class="setting-group"><div class="setting-label">BEAT</div><select id="beat-select" class="global-select"><option value="4">4</option><option value="8" selected>8</option><option value="16">16</option></select></div>
      <div class="setting-group"><div class="setting-label">DRUM</div><select id="drum-select" class="global-select"><option value="Straight">Straight</option><option value="Shuffle" selected>Shuffle</option><option value="Open">Open</option><option value="Trap">Trap</option></select></div>
    </div>
  </header>

  <div id="list-wrapper">
    <div class="col-headers">
      <div class="col-h-loop">roop</div><div class="col-h-part">Part</div><div class="col-h-chord">Chords</div><div class="col-h-tmpl">Template</div><div class="col-h-del"></div>
    </div>
    <main id="line-container"><div class="add-btn" id="add-btn">+</div></main>
    <div class="controls-overlay"><div class="play-btn play" id="play-btn">PLAY</div></div>
  </div>
  <div id="bottom-spacer"></div>
</div>

<div id="modal-overlay"><div id="modal-content"></div></div>

<script>
/**
 * Roppon Code Editor Ver.2.2
 */
const VERSION = "2.2";
const KEYS = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const PARTS = ["イントロ", "Aメロ", "Bメロ", "プレコーラス", "サビ", "間奏", "Cメロ", "アウトロ"];
const TEMPLATES = [
  { name: "王道進行", deg: "IV-V-iii-vi", usage: "サビ最頻出" },
  { name: "マイナー王道", deg: "vi-IV-I-V", usage: "切な系サビ" },
  { name: "小室進行", deg: "vi-IV-V-I", usage: "疾走感" },
  { name: "カノン進行", deg: "I-V-vi-iii-IV-I-IV-V", usage: "感動系" },
  { name: "4度進行", deg: "I-IV-vii°-iii-vi-ii-V-I", usage: "ジャズ/元気" },
  { name: "丸サ進行", deg: "IV-V-iii-vi", usage: "おしゃれ" }
];
const DEGREE_MAP = { "I":0, "II":2, "ii":2, "iii":4, "IV":5, "V":7, "vi":9, "vii°":11, "bVII":10 };

let state = { 
  bpm: 140, keyIndex: 0, beat: 8, drum: "Shuffle", isPlaying: false, 
  lines: [{ loop: true, part: "イントロ", chords: "F-G-Em-Am", template: 0 }], 
  currentLineIndex: -1, nextNoteTime: 0, currentBeat: 0 
};

let audioCtx, timerID;

// --- 音声エンジン ---
function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }

function playTone(freq, time, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(freq, time);
  gain.gain.setValueAtTime(0.15, time);
  gain.gain.exponentialRampToValueAtTime(0.001, time + duration);
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(time); osc.stop(time + duration);
}

function playDrum(time, type) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  if (type === 'kick') {
    osc.frequency.setValueAtTime(150, time);
    osc.frequency.exponentialRampToValueAtTime(0.01, time + 0.1);
    gain.gain.setValueAtTime(0.4, time);
    gain.gain.exponentialRampToValueAtTime(0.01, time + 0.1);
  }
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(time); osc.stop(time + 0.1);
}

function scheduler() {
  while (state.nextNoteTime < audioCtx.currentTime + 0.1) {
    scheduleNote(state.currentBeat, state.nextNoteTime);
    const secondsPerBeat = 60.0 / state.bpm / (state.beat / 4);
    state.nextNoteTime += secondsPerBeat;
    state.currentBeat++;
  }
  timerID = setTimeout(scheduler, 25);
}

function scheduleNote(beatNum, time) {
  if (state.currentLineIndex === -1) return;
  const line = state.lines[state.currentLineIndex];
  const chords = line.chords.split("-").filter(c => c.trim());
  if (chords.length === 0) return;

  const beatInChord = beatNum % state.beat;
  const chordIdx = Math.floor(beatNum / state.beat) % chords.length;

  if (beatInChord === 0) {
    const root = chords[chordIdx].replace(/m|dim/g, '');
    const idx = KEYS.indexOf(root);
    if (idx !== -1) playTone(440 * Math.pow(2, (idx + 48 - 69) / 12), time, 0.4);
  }
  
  // ドラムパターン連動
  const isDownBeat = beatInChord % (state.beat / 2) === 0;
  if (state.drum === "Straight" && isDownBeat) playDrum(time, 'kick');
  if (state.drum === "Shuffle" && (beatInChord === 0 || beatInChord === Math.floor(state.beat * 0.6))) playDrum(time, 'kick');
  if (state.drum === "Trap" && beatNum % 2 === 0) playDrum(time, 'kick');

  if (beatNum >= chords.length * state.beat) {
    state.currentBeat = 0;
    let nextIdx = state.lines.findIndex((l, i) => i > state.currentLineIndex && l.loop);
    if (nextIdx === -1) nextIdx = state.lines.findIndex(l => l.loop);
    state.currentLineIndex = nextIdx;
    updateUIActive();
  }
}

// --- UI描画 ---
function render() {
  const container = document.getElementById('line-container');
  const addBtn = document.getElementById('add-btn');
  container.querySelectorAll('.line-row').forEach(r => r.remove());

  state.lines.forEach((line, idx) => {
    const row = document.createElement('div');
    row.className = 'line-row';
    
    const lBtn = document.createElement('div');
    lBtn.className = `loop-btn ${line.loop ? 'active' : ''}`;
    lBtn.onclick = () => { line.loop = !line.loop; render(); };

    const pWrap = document.createElement('div');
    pWrap.className = 'part-wrapper';
    const pSel = document.createElement('select'); pSel.className = 'part-select';
    PARTS.forEach(p => pSel.add(new Option(p, p))); pSel.value = line.part;
    pSel.onchange = (e) => line.part = e.target.value;
    pWrap.appendChild(pSel);

    const cWrap = document.createElement('div');
    cWrap.className = 'chord-wrapper';
    const cIn = document.createElement('input'); cIn.className = 'chords-input';
    cIn.value = line.chords;
    cIn.onchange = (e) => { line.chords = e.target.value; line.template = -1; render(); };
    cWrap.appendChild(cIn);

    const tDisp = document.createElement('div');
    tDisp.className = 'template-display';
    const t = TEMPLATES[line.template] || { name: "Custom", deg: "---", usage: "Tap to Select" };
    tDisp.innerHTML = `<div class="td-name">${t.name}</div><div class="td-deg">${t.deg}</div><div class="td-usage">${t.usage}</div>`;
    tDisp.onclick = () => showModal(idx);

    const dBtn = document.createElement('div');
    dBtn.className = 'del-btn'; dBtn.textContent = '×';
    dBtn.onclick = () => { if(confirm("この行を削除しますか？")) { state.lines.splice(idx, 1); render(); } };

    row.append(lBtn, pWrap, cWrap, tDisp, dBtn);
    container.insertBefore(row, addBtn);
  });
  updateUIActive();
}

function showModal(lineIdx) {
  const overlay = document.getElementById('modal-overlay');
  const content = document.getElementById('modal-content');
  content.innerHTML = '<h3 style="text-align:center;color:#666;font-size:3vw;">Template</h3>';
  TEMPLATES.forEach((t, i) => {
    const item = document.createElement('div');
    item.className = 'modal-item';
    item.innerHTML = `<strong>${t.name}</strong><br><small style="color:#4CCFFF">${t.deg}</small><br><small style="color:#666">${t.usage}</small>`;
    item.onclick = () => {
      state.lines[lineIdx].template = i;
      state.lines[lineIdx].chords = applyKey(t.deg);
      overlay.style.display = 'none';
      render();
    };
    content.appendChild(item);
  });
  overlay.style.display = 'flex';
  overlay.onclick = (e) => { if(e.target===overlay) overlay.style.display='none'; };
}

function applyKey(degStr) {
  return degStr.split('-').map(d => {
    let rootDeg = d.match(/I|II|iii|IV|V|vi|vii°|bVII/)[0];
    let note = KEYS[(state.keyIndex + DEGREE_MAP[rootDeg]) % 12];
    if (d.includes('m')) note += 'm';
    if (d.includes('°')) note += 'dim';
    return note;
  }).join('-');
}

function updateUIActive() {
  document.querySelectorAll('.line-row').forEach((el, i) => {
    el.classList.toggle('playing', i === state.currentLineIndex);
  });
}

// --- イベント制御 ---
document.getElementById('play-btn').onclick = async () => {
  initAudio();
  if (state.isPlaying) {
    state.isPlaying = false; clearTimeout(timerID);
    document.getElementById('play-btn').className = "play-btn play";
    document.getElementById('play-btn').textContent = "PLAY";
    state.currentLineIndex = -1; updateUIActive();
  } else {
    if (audioCtx.state === 'suspended') await audioCtx.resume();
    state.isPlaying = true;
    state.currentLineIndex = state.lines.findIndex(l => l.loop);
    state.currentBeat = 0; state.nextNoteTime = audioCtx.currentTime + 0.1;
    document.getElementById('play-btn').className = "play-btn stop";
    document.getElementById('play-btn').textContent = "STOP";
    scheduler();
  }
};

document.getElementById('add-btn').onclick = () => {
  state.lines.push({ loop: false, part: "Aメロ", chords: "", template: -1 });
  render();
};

window.onload = () => {
  console.log("Roppon Code Editor Ver." + VERSION + " Initialized");
  const b = document.getElementById('bpm-select'); for(let i=60;i<=200;i++) b.add(new Option(i,i)); b.value=state.bpm;
  const k = document.getElementById('key-select'); KEYS.forEach((n,i)=> k.add(new Option(n,i))); k.value=state.keyIndex;
  const beat = document.getElementById('beat-select');
  const drum = document.getElementById('drum-select');

  b.onchange = (e) => state.bpm = parseInt(e.target.value);
  k.onchange = (e) => { 
    state.keyIndex = parseInt(e.target.value);
    state.lines.forEach(l => { if(l.template !== -1) l.chords = applyKey(TEMPLATES[l.template].deg); });
    render();
  };
  beat.onchange = (e) => state.beat = parseInt(e.target.value);
  drum.onchange = (e) => state.drum = e.target.value;
  render();
};
</script>
</body>
</html>
