<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="screen-orientation" content="portrait">

<title>Roppon Code Editor</title>

<style>

/* ===== iPhone / Android VH Fix ===== */
:root {
  --vh: 1vh;
  --safe-bottom: env(safe-area-inset-bottom);
}

html, body {
  width: 100%;
  height: calc(var(--vh) * 100);
  overflow: hidden;
}

/* ================================== */

/* CSS Reset */
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
               Roboto, Helvetica, Arial, sans-serif;
}

body {
  margin: 0;
  padding: 0;
  background: #000;
  color: #fff;
  touch-action: none;
}

input, select, button {
  outline: none;
  border: none;
  background: none;
  color: inherit;
  font-family: inherit;
}

/* Layout */
#app {
  display: flex;
  flex-direction: column;
  width: 100%;
  height: 100%;
  padding: 3% 3%;
  padding-bottom: calc(3% + var(--safe-bottom));
}

/* Header */
header {
  height: 10%;
  position: relative;
  display: flex;
  flex-direction: column;
  margin-bottom: 1%;
}

.header-title {
  position: absolute;
  top: 2%;
  right: 4%;
  font-size: 3.2vw;
  font-weight: bold;
  color: #666;
  width: 40vw;
  text-align: right;
}

.settings-area {
  height: 65%;
  margin-top: auto;
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
}

.setting-box {
  width: 48%;
  height: 55%;
  background: #1a1a1a;
  border-radius: 8px;
  display: flex;
  align-items: center;
  position: relative;
}

.setting-label {
  position: absolute;
  top: -2.5vh;
  left: 0;
  font-size: 3.5vw;
  color: #888;
  font-weight: bold;
}

/* BPM */
#bpm-input {
  width: 100%;
  height: 100%;
  text-align: center;
  font-size: 6vw;
  font-weight: bold;
  background: #222;
  border-radius: 6px;
}

/* Key */
.key-display {
  flex: 1;
  text-align: center;
  font-size: 6vw;
  font-weight: bold;
}

.key-controls {
  display: flex;
  flex-direction: column;
  gap: 1vh;
  padding-right: 3vw;
}

.key-arrow {
  font-size: 4vw;
  color: #4CCFFF;
}

/* Main */
main {
  height: 70%;
  overflow-y: auto;
  padding-top: 1vh;
  padding-bottom: 3vh;
  -webkit-overflow-scrolling: touch;
}

main::-webkit-scrollbar {
  display: none;
}

/* Rows */
.line-row {
  height: 13.2vh;
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 2vh;
  background: #111;
  border-radius: 8px;
  padding: 0 1vw;
}

.line-row.playing {
  border: 1px solid #4CCFFF;
  box-shadow: 0 0 10px rgba(76,207,255,.3);
}

/* Loop */
.loop-btn {
  width: 5vw;
  height: 5vw;
  border-radius: 50%;
  border: 2px solid #444;
  margin-left: 1.5vw;
}

.loop-btn.active {
  background: #4CCFFF;
  border-color: #4CCFFF;
}

/* Part */
.part-wrapper {
  width: 18%;
  height: 76%;
  position: relative;
}

.part-wrapper::after {
  content: '▼';
  position: absolute;
  right: .5vw;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.8vw;
  color: #4CCFFF;
}

.part-wrapper select {
  width: 100%;
  height: 100%;
  background: #222;
  color: #fff;
  border-radius: 4px;
  font-size: 2.8vw;
}

/* Chords */
.chords-input {
  width: 45%;
  height: 76%;
  background: #222;
  border-radius: 4px;
  font-size: 3.5vw;
  padding: 0 2vw;
  border: 1px solid #333;
}

/* Template */
.template-wrapper {
  width: 30%;
  height: 76%;
  position: relative;
}

.template-wrapper::after {
  content: '▼';
  position: absolute;
  right: .5vw;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.8vw;
  color: #4CCFFF;
}

.template-wrapper select {
  width: 100%;
  height: 100%;
  background: #222;
  color: #aaa;
  border-radius: 4px;
  font-size: 2.2vw;
}

/* Add */
.add-btn {
  width: 100%;
  height: 8vh;
  color: #666;
  font-size: 8vw;
  display: flex;
  justify-content: center;
  align-items: center;
}

/* Footer */
footer {
  height: 20%;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-end;
  padding-bottom: calc(3% + var(--safe-bottom));
}

.page-dots {
  display: flex;
  gap: 1.5vw;
  margin-bottom: 3vh;
}

.dot {
  width: 1.2vw;
  height: 1.2vw;
  border-radius: 50%;
  background: #333;
}

.dot.active {
  background: #4CCFFF;
}

.play-btn {
  width: 22vw;
  height: 22vw;
  border-radius: 50%;
  display: flex;
  justify-content: center;
  align-items: center;
  font-weight: bold;
}

.play-btn.play {
  background: #34C759;
}

.play-btn.stop {
  background: #FF3B30;
}

</style>
</head>

<body>

<div id="app">

<header>
  <div class="header-title">Roppon Code Editor</div>

  <div class="settings-area">

    <div class="setting-box">
      <div class="setting-label">BPM</div>
      <input type="number" id="bpm-input" value="120">
    </div>

    <div class="setting-box">
      <div class="setting-label">Key</div>

      <div class="key-display" id="key-display">C</div>

      <div class="key-controls">
        <div class="key-arrow" id="key-up">▲</div>
        <div class="key-arrow" id="key-down">▼</div>
      </div>
    </div>

  </div>
</header>

<main id="line-container">
  <div class="add-btn" id="add-btn">+</div>
</main>

<footer>

  <div class="page-dots">
    <div class="dot"></div>
    <div class="dot"></div>
    <div class="dot active"></div>
    <div class="dot"></div>
  </div>

  <div class="play-btn play" id="play-btn">PLAY</div>

</footer>

</div>

<script>

/* ===== VH Auto Fix ===== */
function setVH(){
  const vh = window.innerHeight * 0.01;
  document.documentElement
    .style.setProperty('--vh', `${vh}px`);
}

setVH();
window.addEventListener('resize', setVH);
window.addEventListener('orientationchange', setVH);
/* ======================= */

/* ===== Original JS ===== */

const KEYS = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];

let state = {
  bpm:120,
  keyIndex:0,
  isPlaying:false,
  lines:[]
};

const container = document.getElementById("line-container");
const bpmInput = document.getElementById("bpm-input");
const keyDisplay = document.getElementById("key-display");
const playBtn = document.getElementById("play-btn");

function addLine(){
  state.lines.push({
    loop:false,
    part:"A",
    chords:"",
    template:""
  });
  render();
  save();
}

function render(){

  const btn = document.getElementById("add-btn");

  container.innerHTML="";
  state.lines.forEach((l,i)=>{
    const d=document.createElement("div");
    d.className="line-row";
    d.textContent = l.chords || "Empty";
    container.appendChild(d);
  });

  container.appendChild(btn);

  bpmInput.value=state.bpm;
  keyDisplay.textContent=KEYS[state.keyIndex];
}

function save(){
  localStorage.setItem("roppon_data",JSON.stringify(state));
}

function load(){
  const d=localStorage.getItem("roppon_data");
  if(d){
    state=JSON.parse(d);
  }
  if(state.lines.length===0) addLine();
  render();
}

document.getElementById("add-btn").onclick=addLine;

document.getElementById("key-up").onclick=()=>{
  state.keyIndex=(state.keyIndex+1)%12;
  render(); save();
};

document.getElementById("key-down").onclick=()=>{
  state.keyIndex=(state.keyIndex+11)%12;
  render(); save();
};

bpmInput.onchange=e=>{
  state.bpm=parseInt(e.target.value)||120;
  save();
};

playBtn.onclick=()=>{
  state.isPlaying=!state.isPlaying;
  playBtn.textContent=state.isPlaying?"STOP":"PLAY";
  playBtn.className="play-btn "+(state.isPlaying?"stop":"play");
};

load();

</script>

</body>
</html>
